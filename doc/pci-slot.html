
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>PCI Slots &#8212; skiboot 326a466
 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="XSCOM Bindings" href="xscom-node-bindings.html" />
    <link rel="prev" title="PCI" href="pci.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="xscom-node-bindings.html" title="XSCOM Bindings"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pci.html" title="PCI"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">skiboot 326a466
 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">PCI Slots</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="pci-slots">
<h1>PCI Slots<a class="headerlink" href="#pci-slots" title="Permalink to this headline">¶</a></h1>
<p>The PCI slots are instantiated to represent their associated properties and
operations. The slot properties are exported to OS through the device tree
node of the corresponding parent PCI device. The slot operations are used
to accomodate requests from OS regarding the indicated PCI slot:</p>
<blockquote>
<div><ul class="simple">
<li><p>PCI slot reset</p></li>
<li><p>PCI slot property retrival</p></li>
</ul>
</div></blockquote>
<p>The PCI slots are expected to be created by individual platforms based on
the given templates, which are classified to PHB slot or normal one currently.
The PHB slot is instantiated based on PHB types like P7IOC and PHB3. However,
the normal PCI slots are created based on general RC (Root Complex), PCIE switch
ports, PCIE-to-PCIx bridge. Individual platform may create PCI slot, which doesn’t
have existing template.</p>
<p>The PCI slots are created at different stages according to their types. PHB slots
are expected to be created once the PHB is register (struct platform::pci_setup_phb())
because the PHB slot reset operations are required at early stage of PCI enumeration.
The normal slots are populated after their parent PCI devices are instantiated at
struct platform::pci_get_slot_info().</p>
<p>The operation set supplied by the template might be overrided and reimplemented, or
partially. It’s usually done according to the VPD figured out by individual platforms.</p>
<section id="pci-slot-operations">
<h2>PCI Slot Operations<a class="headerlink" href="#pci-slot-operations" title="Permalink to this headline">¶</a></h2>
<p>The following operations are supported to one particular PCI slot. More details
could be found from the definition of struct pci_slot_ops:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>get_presence_state</p></td>
<td><p>Check if any adapter connected to slot</p></td>
</tr>
<tr class="row-odd"><td><p>get_link_state</p></td>
<td><p>Retrieve PCIE link status: up, down, link width</p></td>
</tr>
<tr class="row-even"><td><p>get_power_state</p></td>
<td><p>Retrieve the power status: on, off</p></td>
</tr>
<tr class="row-odd"><td><p>get_attention_state</p></td>
<td><p>Retrieve attention status: on, off, blinking</p></td>
</tr>
<tr class="row-even"><td><p>get_latch_state</p></td>
<td><p>Retrieve latch status</p></td>
</tr>
<tr class="row-odd"><td><p>set_power_state</p></td>
<td><p>Configure the power status: on, off</p></td>
</tr>
<tr class="row-even"><td><p>set_attention_state</p></td>
<td><p>Configure attention status: on, off, blinking</p></td>
</tr>
<tr class="row-odd"><td><p>prepare_link_change</p></td>
<td><p>Prepare PCIE link status change</p></td>
</tr>
<tr class="row-even"><td><p>poll_link</p></td>
<td><p>Poll PCIE link until it’s up or down permanently</p></td>
</tr>
<tr class="row-odd"><td><p>creset</p></td>
<td><p>Complete reset, only available to PHB slot</p></td>
</tr>
<tr class="row-even"><td><p>freset</p></td>
<td><p>Fundamental reset</p></td>
</tr>
<tr class="row-odd"><td><p>hreset</p></td>
<td><p>Hot reset</p></td>
</tr>
<tr class="row-even"><td><p>poll</p></td>
<td><p>Interface for OPAL API to drive internal state machine</p></td>
</tr>
<tr class="row-odd"><td><p>add_properties</p></td>
<td><p>Additional PCI slot properties seen by platform</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="pci-slot-properties">
<h1>PCI Slot Properties<a class="headerlink" href="#pci-slot-properties" title="Permalink to this headline">¶</a></h1>
<p>The following PCI slot properties have been exported through PCI device tree
node for a root port, a PCIE switch port, or a PCIE to PCIx bridge. If the
individual platforms (e.g. Firenze and Apollo) have VPD for the PCI slot, they
should extract the PCI slot properties from VPD and export them accordingly.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 72%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ibm,reset-by-firmware</p></td>
<td><p>Boolean indicating whether the slot reset should be done in firmware</p></td>
</tr>
<tr class="row-odd"><td><p>ibm,slot-pluggable</p></td>
<td><p>Boolean indicating whether the slot is pluggable</p></td>
</tr>
<tr class="row-even"><td><p>ibm,slot-surprise-pluggable</p></td>
<td><p>Boolean indicating whether the slot supports surprise hotplug</p></td>
</tr>
<tr class="row-odd"><td><p>ibm,slot-broken-pdc</p></td>
<td><p>Boolean indicating whether PDC (Presence Detection Change) is broken</p></td>
</tr>
<tr class="row-even"><td><p>ibm,slot-power-ctl</p></td>
<td><p>Boolean indicating whether the slot has power control</p></td>
</tr>
<tr class="row-odd"><td><p>ibm,slot-wired-lanes</p></td>
<td><p>The number of hardware lanes that are wired</p></td>
</tr>
<tr class="row-even"><td><p>ibm,slot-pwr-led-ctl</p></td>
<td><p>Presence of slot power led, and controlling entity</p></td>
</tr>
<tr class="row-odd"><td><p>ibm,slot-attn-led-ctl</p></td>
<td><p>Presence of slot ATTN led, and controlling entity</p></td>
</tr>
</tbody>
</table>
<section id="pci-hotplug">
<h2>PCI Hotplug<a class="headerlink" href="#pci-hotplug" title="Permalink to this headline">¶</a></h2>
<p>The implementation of PCI slot hotplug heavily relies on its power state.
Initially, the slot is powered off if there are no adapters behind it.
Otherwise, the slot should be powered on.</p>
<p>In hot add scenario, the adapter is physically inserted to PCI slot. Then
the PCI slot is powered on by OPAL API opal_pci_set_power_state(). The
power is supplied to the PCI slot, the adapter behind the PCI slot is
probed and the device sub-tree (for hot added devices) is populated. A
OPAL message is sent to OS on completion. The OS needs retrieve the device
sub-tree through OPAL API opal_get_device_tree(), unflatten it and populate
the device sub-tree. After that, the adapter behind the PCI slot should
be probed and added to the system.</p>
<p>On the other hand, the OS removes the adapter behind the PCI slot before
calling opal_pci_set_power_state(). Skiboot cuts off the power supply to
the PCI slot, removes the adapter behind the PCI slot and the corresponding
device sub-tree. A OPAL message (OPAL_MSG_ASYNC_COMP) is sent to OS. The
OS removes the device sub-tree for the adapter behind the PCI slot.</p>
<p>The OPAL message used in PCI hotplug is comprised of 4 dwords in sequence:
asychronous token from OS, PCI slot device node’s phandle, OPAL_PCI_SLOT_POWER_{ON,
OFF}, OPAL_SUCCESS or errcode.</p>
<p>The states OPAL_PCI_SLOT_OFFLINE and OPAL_PCI_SLOT_ONLINE are used for removing
or adding devices behind the slot. The device nodes in the device tree are
removed or added accordingly, without actually changing the slot’s power state.
The API call will return OPAL_SUCCESS immediately and no further asynchronous
message will be sent.</p>
</section>
<section id="pci-slot-on-apollo-and-firenze">
<h2>PCI Slot on Apollo and Firenze<a class="headerlink" href="#pci-slot-on-apollo-and-firenze" title="Permalink to this headline">¶</a></h2>
<p>On IBM’s Apollo and Firenze platform, the PCI VPD is fetched from dedicated LID,
which is organized in so-called 1004, 1005, or 1006 format. 1006 mapping format
isn’t supported currently. The PCI slot properties are figured out from the VPD.
On the other hand, there might have external power management entity hooked to
I2C buses for one PCI slot. The fundamental reset operation of the PCI slot should
be implemented based on the external power management entity for that case.</p>
<p>On Firenze platform, PERST pin is accessible through bit#10 of PCI config register
(offset: 0x80) for those PCI slots behind some PLX switch downstream ports. For
those PCI slots, PERST pin is utilized to implement fundamental reset if external
power management entity doesn’t exist.</p>
<p>For Apollo and Firenze platform, following PCI slot properties are exported through
PCI device tree node except those generic properties (as above):</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 32%" />
<col style="width: 68%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Property</p></th>
<th class="head"><p>Definition</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ibm,slot-location-code</p></td>
<td><p>System location code string for the slot connector</p></td>
</tr>
<tr class="row-odd"><td><p>ibm,slot-label</p></td>
<td><p>Slot label, part of “ibm,slot-location-code”</p></td>
</tr>
</tbody>
</table>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PCI Slots</a><ul>
<li><a class="reference internal" href="#pci-slot-operations">PCI Slot Operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pci-slot-properties">PCI Slot Properties</a><ul>
<li><a class="reference internal" href="#pci-hotplug">PCI Hotplug</a></li>
<li><a class="reference internal" href="#pci-slot-on-apollo-and-firenze">PCI Slot on Apollo and Firenze</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="pci.html"
                        title="previous chapter">PCI</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="xscom-node-bindings.html"
                        title="next chapter">XSCOM Bindings</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/pci-slot.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="xscom-node-bindings.html" title="XSCOM Bindings"
             >next</a> |</li>
        <li class="right" >
          <a href="pci.html" title="PCI"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">skiboot 326a466
 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">PCI Slots</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2017, IBM, others.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>